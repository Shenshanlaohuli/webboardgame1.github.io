<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schadenfreude å¹¸ç¾ä¹ç¥¸ - æ‰‹æœºç²¾ç®€ç‰ˆ</title>
    <style>
        :root {
            --card-width: 58px;  
            --card-height: 84px; 
            --bg-color: #2c3e50;
            --table-color: #27ae60;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç•Œé¢å¸ƒå±€ */
        #setup-screen, #game-over-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            text-align: center;
        }

        .hidden { display: none !important; }

        h1 { margin-bottom: 10px; font-size: 24px; color: #f1c40f; }
        button {
            padding: 12px 30px;
            margin: 10px;
            font-size: 18px;
            cursor: pointer;
            background: #3498db;
            border: none;
            color: white;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button:active { transform: scale(0.95); background: #2980b9; }

        /* æ¸¸æˆæ¡Œé¢ */
        #game-board {
            flex: 1;
            position: relative;
            background-color: var(--table-color);
            overflow: hidden;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ¡ */
        #info-panel {
            position: absolute;
            top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            z-index: 50;
            backdrop-filter: blur(2px);
        }

        #status-text { 
            position: absolute; 
            top: 50px; 
            width: 100%; 
            text-align: center; 
            font-weight: bold; 
            color: #f1c40f; 
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
            font-size: 16px;
        }

        /* ç©å®¶åŒºåŸŸå¸ƒå±€ */
        .player-area {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90px; 
            transition: all 0.3s ease;
        }

        /* ç©å®¶è‡ªå·± (åº•éƒ¨) */
        #p0 { 
            bottom: 60px;
            left: 0; 
            width: 100%; 
            z-index: 60;
        }
        
        /* ç”µè„‘ç©å®¶ä½ç½® */
        body.players-3 #p1 { top: 60px; left: 10px; }
        body.players-3 #p2 { top: 60px; right: 10px; }

        body.players-4 #p1 { top: 40%; left: 5px; transform: translateY(-50%); }
        body.players-4 #p2 { top: 60px; left: 50%; transform: translateX(-50%); }
        body.players-4 #p3 { top: 40%; right: 5px; transform: translateY(-50%); }

        body.players-5 #p1 { bottom: 180px; left: 5px; }
        body.players-5 #p2 { top: 60px; left: 15px; }
        body.players-5 #p3 { top: 60px; right: 15px; }
        body.players-5 #p4 { bottom: 180px; right: 5px; }

        .player-name { 
            background: rgba(0,0,0,0.5); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 11px;
            white-space: nowrap;
        }
        
        .player-score { 
            font-size: 12px; 
            color: #f1c40f; 
            text-shadow: 1px 1px 1px black; 
            margin: 2px 0;
            font-weight: bold;
        }

        /* è®¡åˆ†ç‰Œå±•ç¤ºåŒº (Loot) */
        .loot-area {
            display: flex;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            justify-content: center;
            gap: 3px; /* å¡ç‰Œé—´è· */
            min-height: 20px;
            background: rgba(0,0,0,0.15);
            padding: 4px;
            border-radius: 4px;
            width: 100%;
            pointer-events: none;
        }
        
        #p0 .loot-area {
            width: auto;
            min-width: 120px;
            max-width: 90%;
            margin-bottom: 8px;
        }

        /* æ‰‹ç‰ŒåŒºåŸŸ (åªå½±å“æ‰‹é‡Œçš„ç‰Œï¼Œä¸å½±å“è®¡åˆ†ç‰Œ) */
        .hand {
            display: flex;
            justify-content: center;
            height: var(--card-height);
            width: 100%;
            margin-top: 5px;
        }
        
        /* å…³é”®ä¿®å¤ï¼šåªè®© #hand-0 é‡Œçš„ card é‡å ï¼Œè€Œä¸æ˜¯ #p0 é‡Œæ‰€æœ‰çš„ card */
        #p0 .hand .card {
            margin-left: -22px; 
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        #p0 .hand .card:first-child { margin-left: 0; }

        /* è®¡åˆ†å°ç‰Œæ ·å¼ä¿®æ­£ */
        #p0 .loot-area .card {
            margin-left: 0;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* ä¸­å¤®å‡ºç‰ŒåŒº */
        #trick-area {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .trick-card {
            position: absolute;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* å¡ç‰Œé€šç”¨æ ·å¼ */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 6px;
            background: white;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            font-size: 26px;
            user-select: none;
            position: relative;
            border: 2px solid #fff;
            text-shadow: 0px 1px 0px rgba(255,255,255,0.5);
        }

        .card.mini-card {
            width: 22px; /* ç¨å¾®åŠ å¤§è®¡åˆ†ç‰Œå®½åº¦ä»¥ä¾¿çœ‹æ¸… */
            height: 30px;
            font-size: 12px;
            border-width: 1px;
            border-radius: 2px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .card.clickable { transform: translateY(0); transition: transform 0.1s; z-index: 100; }
        .card.clickable:active { transform: translateY(-20px); }
        .card.disabled { opacity: 0.4; filter: grayscale(90%); }
        
        .card-owner-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: white;
            white-space: nowrap;
            text-shadow: 1px 1px 2px black;
            background: rgba(0,0,0,0.4);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* èŠ±è‰²é¢œè‰² */
        .suit-red { background-color: #e74c3c; color: white; border-color: #c0392b; text-shadow: none;}
        .suit-blue { background-color: #3498db; color: white; border-color: #2980b9; text-shadow: none;}
        .suit-yellow { background-color: #f1c40f; color: black; border-color: #f39c12; }
        .suit-green { background-color: #2ecc71; color: black; border-color: #27ae60; }
        .suit-wild { background-color: #95a5a6; color: white; border-color: #7f8c8d; text-shadow: none;}

        /* è®¡åˆ†æ¿ */
        #score-board {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .score-row { display: flex; justify-content: space-between; margin: 8px 0; border-bottom: 1px solid #eee; padding-bottom: 4px; font-size: 14px;}
        .eliminated { text-decoration: line-through; color: #e74c3c; }
        .tie-eliminated { text-decoration: line-through; color: #e67e22; }
        .winner { font-weight: bold; color: #27ae60; margin: 10px 0; font-size: 18px;}
        .rules-text { font-size: 12px; text-align: left; color: #ccc; line-height: 1.4; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 15px;}

    </style>
</head>
<body>

    <!-- æ¸¸æˆè®¾ç½®ç•Œé¢ -->
    <div id="setup-screen">
        <h1>Schadenfreude å¹¸ç¾ä¹ç¥¸</h1>
        <p style="color: #ddd;">æ‰‹æœºç²¾ç®€ç‰ˆ</p>
        <div>
            <button onclick="startGame(3)">3 äºº</button>
            <button onclick="startGame(4)">4 äºº</button>
            <button onclick="startGame(5)">5 äºº</button>
        </div>
        <div class="rules-text">
            1. <b>å‡ºç‰Œ</b>ï¼šæœ‰é¢†å¤´èŠ±è‰²å¿…é¡»å‡º(æˆ–ç™¾æ­)ï¼Œæ²¡æœ‰å¯éšæ„ã€‚<br>
            2. <b>èµ¢ç‰Œ</b>ï¼šé¢†å¤´èŠ±è‰²(å«ç™¾æ­)ä¸­<b>ç¬¬äºŒå¤§</b>è€…èµ¢ã€‚<br>
            3. <b>åƒåˆ†</b>ï¼šèµ¢å®¶æ‹¿èµ°<span style="color:#f1c40f">èµ¢çš„ç‰Œ</span>åŠ<span style="color:#f1c40f">å«ç‰Œ</span>ã€‚<br>
            4. <b>æ¶ˆé™¤</b>ï¼šå‡‘é½å¯¹å­ç«‹å³å¼ƒæ‰ã€‚<br>
            5. <b>èƒœåˆ©</b>ï¼š>40åˆ†æ·˜æ±°ã€‚æœ€æ¥è¿‘40åˆ†èµ¢ã€‚å¹³å±€æœ€é«˜åˆ†åŒåŒæ·˜æ±°ã€‚
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <div id="game-over-screen" class="hidden">
        <div id="score-board">
            <h2 id="game-over-title">æ¸¸æˆç»“æŸ</h2>
            <div id="final-scores"></div>
            <button onclick="location.reload()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-board" class="hidden">
        <div id="info-panel">
            <div>R: <span id="round-num">1</span></div>
            <div id="lead-indicator">é¢†å¤´: <span id="lead-suit-name">æ— </span></div>
        </div>
        
        <div id="status-text">å‡†å¤‡å¼€å§‹</div>

        <div id="trick-area"></div>
        
        <!-- ç©å®¶åŒºåŸŸåŠ¨æ€ç”Ÿæˆ -->
    </div>

<script>
    const SUITS = ['red', 'blue', 'yellow', 'green'];
    const WILD_SUIT = 'wild';
    const CARD_VALUES = [-3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 9];
    
    let state = {
        numPlayers: 0,
        players: [], 
        deck: [],
        currentTrick: [], 
        leadSuit: null,
        currentPlayerIndex: 0,
        startPlayerIndex: -1, 
        roundNum: 0,
        gameActive: false
    };

    function createDeck(numPlayers) {
        let deck = [];
        deck.push({ suit: WILD_SUIT, value: 0, uid: 'w0' });
        deck.push({ suit: WILD_SUIT, value: 10, uid: 'w10' });
        SUITS.forEach(suit => {
            CARD_VALUES.forEach(val => {
                if (numPlayers === 3) {
                    if (val === -2 || val === -1 || val === 9) return;
                }
                deck.push({ suit: suit, value: val, uid: suit + val });
            });
        });
        return deck;
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startGame(num) {
        state.numPlayers = num;
        state.players = [];
        for (let i = 0; i < num; i++) {
            state.players.push({
                id: i,
                name: i === 0 ? "ä½ " : `ç”µè„‘${i}`,
                isHuman: i === 0,
                hand: [],
                loot: [], 
                totalScore: 0,
                eliminated: false,
                tieEliminated: false
            });
        }

        document.body.className = `players-${num}`;
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-board').classList.remove('hidden');

        initUI();
        state.startPlayerIndex = Math.floor(Math.random() * num);
        startRound();
    }

    function initUI() {
        const board = document.getElementById('game-board');
        document.querySelectorAll('.player-area').forEach(e => e.remove());

        state.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'player-area';
            div.id = `p${i}`;
            
            // ç©å®¶æ˜¾ç¤º hand div
            let handHtml = i === 0 ? `<div class="hand" id="hand-${i}"></div>` : '';
            
            div.innerHTML = `
                <div class="player-name">${p.name}</div>
                <div class="player-score"><span id="score-val-${i}">0</span>åˆ†</div>
                <div class="loot-area" id="loot-${i}"></div>
                ${handHtml}
            `;
            board.appendChild(div);
        });
    }

    function startRound() {
        state.roundNum++;
        document.getElementById('round-num').innerText = state.roundNum;
        document.getElementById('status-text').innerText = "å‘ç‰Œä¸­...";
        document.getElementById('game-over-screen').classList.add('hidden');

        let deck = shuffle(createDeck(state.numPlayers));
        let cardsPerPlayer = 12;
        if (state.numPlayers === 5) cardsPerPlayer = 10;

        state.players.forEach(p => {
            p.hand = deck.splice(0, cardsPerPlayer);
            p.hand.sort((a, b) => {
                if (a.suit === b.suit) return a.value - b.value;
                return a.suit.localeCompare(b.suit);
            });
            p.loot = [];
        });

        state.currentPlayerIndex = state.startPlayerIndex;
        state.currentTrick = [];
        state.leadSuit = null;
        state.gameActive = true;

        updateUI();
        playTurn();
    }

    function playTurn() {
        if (!state.gameActive) return;
        updateUI();
        
        const player = state.players[state.currentPlayerIndex];
        const statusEl = document.getElementById('status-text');

        if (player.isHuman) {
            statusEl.innerText = "ä½ çš„å›åˆ";
            enableHumanInput();
        } else {
            statusEl.innerText = `${player.name} æ€è€ƒä¸­...`;
            setTimeout(() => {
                aiPlay(player);
            }, 600 + Math.random() * 400);
        }
    }

    function aiPlay(player) {
        const validCards = getValidCards(player.hand);
        const randomIndex = Math.floor(Math.random() * validCards.length);
        playCardAction(player.id, validCards[randomIndex]);
    }

    function getValidCards(hand) {
        if (state.currentTrick.length === 0 || state.leadSuit === WILD_SUIT) {
            return hand;
        }
        let currentLeadSuit = state.leadSuit; 
        const hasLeadSuit = hand.some(c => c.suit === currentLeadSuit);

        if (hasLeadSuit) {
            return hand.filter(c => c.suit === currentLeadSuit || c.suit === WILD_SUIT);
        } else {
            return hand;
        }
    }

    function enableHumanInput() {
        const hand = state.players[0].hand;
        const validCards = getValidCards(hand);
        const handDiv = document.getElementById(`hand-0`);
        const cardEls = handDiv.getElementsByClassName('card');

        for (let i = 0; i < hand.length; i++) {
            const cardObj = hand[i];
            const el = cardEls[i];
            if (validCards.includes(cardObj)) {
                el.classList.add('clickable');
                el.classList.remove('disabled');
                el.onclick = () => {
                    Array.from(cardEls).forEach(c => c.onclick = null);
                    playCardAction(0, cardObj);
                };
            } else {
                el.classList.add('disabled');
                el.classList.remove('clickable');
                el.onclick = null;
            }
        }
    }

    function playCardAction(playerId, card) {
        const player = state.players[playerId];
        const cardIndex = player.hand.indexOf(card);
        if (cardIndex > -1) player.hand.splice(cardIndex, 1);

        state.currentTrick.push({ playerId: playerId, card: card });

        if (state.currentTrick.length === 1) {
            if (card.suit !== WILD_SUIT) {
                state.leadSuit = card.suit;
            } else {
                state.leadSuit = WILD_SUIT; 
            }
        } else if (state.leadSuit === WILD_SUIT && card.suit !== WILD_SUIT) {
            state.leadSuit = card.suit;
        }

        updateUI();

        if (state.currentTrick.length === state.numPlayers) {
            setTimeout(resolveTrick, 800);
        } else {
            state.currentPlayerIndex = (state.currentPlayerIndex + 1) % state.numPlayers;
            playTurn();
        }
    }

    function resolveTrick() {
        const trick = state.currentTrick;
        let finalLeadSuit = state.leadSuit;
        
        let leadSuitCards = [];
        let offSuitCards = []; 

        trick.forEach(t => {
            if (finalLeadSuit === WILD_SUIT || t.card.suit === finalLeadSuit || t.card.suit === WILD_SUIT) {
                leadSuitCards.push(t);
            } else {
                offSuitCards.push(t);
            }
        });

        leadSuitCards.sort((a, b) => b.card.value - a.card.value);

        let winnerEntry = (leadSuitCards.length === 1) ? leadSuitCards[0] : leadSuitCards[1];
        const winnerId = winnerEntry.playerId;
        const winner = state.players[winnerId];

        let lootCount = 0;
        winner.loot.push(winnerEntry.card);
        lootCount++;

        offSuitCards.forEach(t => {
            winner.loot.push(t.card);
            lootCount++;
        });

        document.getElementById('status-text').innerText = `${winner.name} èµ¢äº†!`;
        processPairs(winner);

        setTimeout(() => {
            state.currentTrick = [];
            state.leadSuit = null;
            state.currentPlayerIndex = winnerId; 
            updateUI(); 

            if (state.players[0].hand.length === 0) {
                endRound();
            } else {
                playTurn();
            }
        }, 1500);
    }

    function processPairs(player) {
        let counts = {};
        player.loot.forEach(c => {
            counts[c.value] = (counts[c.value] || 0) + 1;
        });
        
        let newLoot = [];
        for (let valStr in counts) {
            let val = parseInt(valStr);
            let count = counts[valStr];
            let keep = count % 2;
            
            if (keep > 0) {
                let cardsOfVal = player.loot.filter(c => c.value === val);
                newLoot.push(cardsOfVal[0]); 
            }
        }
        player.loot = newLoot;
    }

    function endRound() {
        let minScore = 9999;
        let minScorePlayers = [];

        state.players.forEach(p => {
            let roundScore = 0;
            p.loot.forEach(c => {
                if (c.value < 0 || c.value > 0) roundScore += c.value;
            });
            p.totalScore += roundScore;
        });

        checkGameOver();
        if (!state.gameActive) return;

        state.players.forEach(p => {
            if (p.eliminated) return;
            if (p.totalScore < minScore) {
                minScore = p.totalScore;
                minScorePlayers = [p.id];
            } else if (p.totalScore === minScore) {
                minScorePlayers.push(p.id);
            }
        });
        state.startPlayerIndex = minScorePlayers[Math.floor(Math.random() * minScorePlayers.length)];

        alert(`æœ¬è½®ç»“æŸã€‚ä¸‹ä¸€è½®èµ·å§‹: ${state.players[state.startPlayerIndex].name}`);
        startRound();
    }

    function checkGameOver() {
        let anyoneOver40 = state.players.some(p => p.totalScore > 40);
        
        if (anyoneOver40) {
            state.gameActive = false;
            
            state.players.forEach(p => {
                if (p.totalScore > 40) p.eliminated = true;
            });

            let survivors = state.players.filter(p => p.totalScore <= 40);
            let winner = null;

            survivors.sort((a, b) => b.totalScore - a.totalScore);

            while (survivors.length > 0) {
                let currentMaxScore = survivors[0].totalScore;
                let tiedGroup = survivors.filter(p => p.totalScore === currentMaxScore);
                
                if (tiedGroup.length === 1) {
                    winner = tiedGroup[0];
                    break;
                } else {
                    tiedGroup.forEach(p => {
                        p.eliminated = true;
                        p.tieEliminated = true; 
                    });
                    survivors = survivors.filter(p => p.totalScore !== currentMaxScore);
                }
            }

            let resultHTML = "";
            if (winner) {
                resultHTML = `<h2 class='winner'>ğŸ‰ èµ¢å®¶: ${winner.name} (${winner.totalScore}åˆ†) ğŸ‰</h2>`;
            } else {
                resultHTML = "<h3 style='color:orange'>æ— äººè·èƒœ (çˆ†åˆ†/å¹³å±€)</h3>";
            }

            let listHTML = state.players.map(p => {
                let status = "";
                if (p.eliminated) {
                    if (p.tieEliminated) status = "<span class='tie-eliminated'>(å¹³å±€)</span>";
                    else status = "<span class='eliminated'>(çˆ†åˆ†)</span>";
                }
                let winMark = (winner && p.id === winner.id) ? "ğŸ†" : "";
                
                return `<div class="score-row">
                            <span>${p.name} ${status} ${winMark}</span>
                            <span>${p.totalScore}</span>
                        </div>`;
            }).join('');

            document.getElementById('final-scores').innerHTML = resultHTML + listHTML;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    }

    function updateUI() {
        const leadSuitMap = {
            'red': '<span style="color:#e74c3c">çº¢</span>',
            'blue': '<span style="color:#3498db">è“</span>',
            'yellow': '<span style="color:#f1c40f">é»„</span>',
            'green': '<span style="color:#2ecc71">ç»¿</span>',
            'wild': '<span style="color:#95a5a6">ç™¾æ­</span>'
        };
        document.getElementById('lead-suit-name').innerHTML = state.leadSuit ? leadSuitMap[state.leadSuit] : 'æ— ';

        state.players.forEach(p => {
            document.getElementById(`score-val-${p.id}`).innerText = p.totalScore;

            const lootDiv = document.getElementById(`loot-${p.id}`);
            lootDiv.innerHTML = '';
            let sortedLoot = [...p.loot].sort((a,b) => a.value - b.value);
            sortedLoot.forEach(card => {
                let miniCard = createCardEl(card);
                miniCard.classList.add('mini-card'); 
                lootDiv.appendChild(miniCard);
            });

            if (p.isHuman) {
                const handDiv = document.getElementById(`hand-${p.id}`);
                handDiv.innerHTML = '';
                p.hand.forEach(card => {
                    handDiv.appendChild(createCardEl(card));
                });
            }
        });

        const trickArea = document.getElementById('trick-area');
        trickArea.innerHTML = '';
        state.currentTrick.forEach((item, index) => {
            const cardEl = createCardEl(item.card);
            cardEl.classList.add('trick-card');
            
            let count = state.currentTrick.length;
            let offset = (index - (count - 1)/2) * 35;
            
            cardEl.style.transform = `translateX(${offset}px)`;
            cardEl.style.zIndex = index;

            const label = document.createElement('div');
            label.className = 'card-owner-label';
            label.innerText = state.players[item.playerId].name;
            cardEl.appendChild(label);

            trickArea.appendChild(cardEl);
        });
    }

    function createCardEl(card) {
        const el = document.createElement('div');
        el.className = `card suit-${card.suit}`;
        el.innerText = card.value;
        return el;
    }
</script>
</body>
</html>